<!DOCTYPE html>
<html>
  <head>
    <title>BST Visualizer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f6f5;
        margin: 0;
        padding: 40px 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 900px;
        text-align: center;
      }
      h2 {
        color: #2f4f4f;
        margin-bottom: 30px;
        font-size: 28px;
      }
      .canvas-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        margin-bottom: 30px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      canvas {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background-color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .info-section {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #228b22;
        margin-bottom: 20px;
        text-align: left;
      }
      .info-section h3 {
        color: #2f4f4f;
        margin: 0 0 10px 0;
        font-size: 16px;
      }
      .info-section p {
        margin: 5px 0;
        color: #555;
        font-size: 14px;
      }
      .navigation {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .nav-button {
        display: inline-block;
        padding: 12px 24px;
        background-color: #228b22;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .nav-button:hover {
        background-color: #196619;
      }
      .nav-button.secondary {
        background-color: #6c757d;
      }
      .nav-button.secondary:hover {
        background-color: #545b62;
      }
      .loading {
        color: #6c757d;
        font-style: italic;
        padding: 20px;
      }
      .error {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      @media (max-width: 600px) {
        .container {
          padding: 20px;
          margin: 0 10px;
        }
        canvas {
          width: 100%;
          max-width: 100%;
          height: auto;
        }
        .navigation {
          flex-direction: column;
        }
        .nav-button {
          width: 100%;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Your Binary Search Tree</h2>

      <div class="canvas-container">
        <div id="loadingMessage" class="loading">Loading your tree...</div>
        <div id="errorMessage" class="error" style="display: none"></div>
        <canvas
          id="treeCanvas"
          width="800"
          height="550"
          style="display: none"
        ></canvas>
      </div>

      <div class="info-section">
        <h3>Tree Key</h3>
        <p>
          <strong>Blue circles</strong> represent nodes with their values inside
        </p>
        <p>
          <strong>Lines</strong> connect parent nodes to their left and right
          children
        </p>
        <p>
          <strong>Left children</strong> contain values smaller than their
          parent
        </p>
        <p>
          <strong>Right children</strong> contain values larger than their
          parent
        </p>
      </div>

      <div class="navigation">
        <a href="/enter-numbers" class="nav-button">‚Üê Create New Tree</a>
        <a href="/previous-trees" class="nav-button secondary"
          >View Tree History</a
        >
      </div>
    </div>

    <script>
      const loadingEl = document.getElementById("loadingMessage");
      const errorEl = document.getElementById("errorMessage");
      const canvas = document.getElementById("treeCanvas");
      const ctx = canvas.getContext("2d");

      // Fetch the most recent tree JSON
      fetch("/previous-trees/latest")
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then((tree) => {
          console.log("Fetched Tree JSON:", tree);

          loadingEl.style.display = "none";
          canvas.style.display = "block";

          // Check if tree is empty
          if (!tree || Object.keys(tree).length === 0) {
            throw new Error("No trees found. Create a tree first!");
          }

          // Enhanced drawing function
          const nodeRadius = 18;
          const levelHeight = 70;

          function drawNode(node, x, y, levelSpacing) {
            if (!node) return;

            ctx.strokeStyle = "#6c757d";
            ctx.lineWidth = 2;

            if (node.left) {
              ctx.beginPath();
              ctx.moveTo(x, y);
              ctx.lineTo(x - levelSpacing, y + levelHeight);
              ctx.stroke();
              drawNode(
                node.left,
                x - levelSpacing,
                y + levelHeight,
                levelSpacing / 2
              );
            }

            if (node.right) {
              ctx.beginPath();
              ctx.moveTo(x, y);
              ctx.lineTo(x + levelSpacing, y + levelHeight);
              ctx.stroke();
              drawNode(
                node.right,
                x + levelSpacing,
                y + levelHeight,
                levelSpacing / 2
              );
            }

            ctx.beginPath();
            ctx.arc(x, y, nodeRadius, 0, 2 * Math.PI);

            const gradient = ctx.createRadialGradient(
              x - 5,
              y - 5,
              0,
              x,
              y,
              nodeRadius
            );
            gradient.addColorStop(0, "#87ceeb");
            gradient.addColorStop(1, "#4682b4");
            ctx.fillStyle = gradient;
            ctx.fill();

            ctx.strokeStyle = "#2f4f4f";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(node.value, x, y);
          }

          // Clear canvas and draw tree
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawNode(tree, canvas.width / 2, 50, 180);
        })
        .catch((err) => {
          console.error("Error fetching tree JSON:", err);

          // Hide loading, show error
          loadingEl.style.display = "none";
          errorEl.style.display = "block";
          errorEl.innerHTML = `
            <strong>Unable to load tree:</strong><br>
            ${err.message}<br><br>
            <em>Make sure you've created at least one tree first by visiting the main page.</em>
          `;
        });
    </script>
  </body>
</html>
